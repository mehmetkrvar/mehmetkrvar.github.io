<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institutional Trading Engine - Web Edition</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        pre { background-color: #000; color: #0f0; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-size: 12px; }
        .loading { display: none; color: #3b82f6; }
        .metric-box { background: #334155; padding: 10px; border-radius: 8px; text-align: center; }
        .metric-title { font-size: 0.8rem; color: #94a3b8; }
        .metric-value { font-size: 1.2rem; font-weight: bold; }
    </style>

    <py-config>
        packages = ["pandas", "numpy", "matplotlib"]
    </py-config>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1><i class="fas fa-chart-line text-primary"></i> Institutional AI Trader</h1>
            <p class="text-muted">Geli≈ümi≈ü Algoritmik Strateji Motoru (WebAssembly Edition)</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-lg mb-3">
                <div class="card-header fw-bold"><i class="fas fa-cogs"></i> Ayarlar</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Hisse Sembol√º (Yahoo Finance)</label>
                        <input type="text" id="symbol_input" class="form-control" value="THYAO.IS" placeholder="√ñrn: AAPL, BTC-USD, THYAO.IS">
                        <small class="text-muted">Not: '.IS' uzantƒ±sƒ± BIST i√ßin gereklidir.</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Periyot</label>
                        <select id="interval_input" class="form-select">
                            <option value="60m">1 Saatlik</option>
                            <option value="90m">90 Dakikalƒ±k</option>
                            <option value="1d">G√ºnl√ºk</option>
                        </select>
                    </div>
                    <button id="run_btn" class="btn btn-primary w-100" py-click="main_process()">
                        <i class="fas fa-play"></i> Analizi Ba≈ülat
                    </button>
                    <div id="loading_spinner" class="loading mt-3 text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i><br>Yapay Zeka √áalƒ±≈üƒ±yor...
                    </div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header fw-bold"><i class="fas fa-flag-checkered"></i> AI Kararƒ±</div>
                <div class="card-body text-center">
                    <h2 id="final_decision" class="display-6">--</h2>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="metric-box">
                                <div class="metric-title">Stop Loss</div>
                                <div id="stop_loss_disp" class="metric-value text-danger">--</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-box">
                                <div class="metric-title">Take Profit</div>
                                <div id="take_profit_disp" class="metric-value text-success">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-lg mb-3">
                <div class="card-header fw-bold"><i class="fas fa-terminal"></i> Sistem Loglarƒ±</div>
                <div class="card-body p-0">
                    <pre id="log_output">Sistem hazƒ±r. Analizi ba≈ülatmak i√ßin butona basƒ±n...</pre>
                </div>
            </div>
            
            <div class="card shadow-lg">
                <div class="card-header fw-bold"><i class="fas fa-chart-area"></i> Backtest Sonu√ßlarƒ± (Equity Curve)</div>
                <div class="card-body">
                    <div id="chart_area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<py-script>
import pandas as pd
import numpy as np
import random
import json
from pyodide.http import open_url
import matplotlib.pyplot as plt
from js import document, console

# ==============================================================================
# 1. SAF NUMPY MATEMATƒ∞K MOTORU (Numba yerine Optimize Edilmi≈ü NumPy)
# ==============================================================================

def log(message):
    """HTML'deki log alanƒ±na yazƒ± yazar"""
    log_el = document.getElementById("log_output")
    current_text = log_el.innerHTML
    log_el.innerHTML = current_text + "\n" + message
    log_el.scrollTop = log_el.scrollHeight

def calculate_supertrend_numpy(high, low, close, period, multiplier):
    m = len(close)
    
    # ATR Hesaplama
    tr1 = high - low
    tr2 = np.abs(high - np.roll(close, 1))
    tr3 = np.abs(low - np.roll(close, 1))
    tr = np.maximum(tr1, np.maximum(tr2, tr3))
    tr[0] = tr[1] # ƒ∞lk deƒüeri d√ºzelt
    
    # Wilder's Smoothing for ATR
    atr = np.zeros(m)
    atr[period-1] = np.mean(tr[:period])
    for i in range(period, m):
        atr[i] = (atr[i-1] * (period - 1) + tr[i]) / period

    # Basic Bands
    hl2 = (high + low) / 2
    basic_upper = hl2 + (multiplier * atr)
    basic_lower = hl2 - (multiplier * atr)
    
    final_upper = np.zeros(m)
    final_lower = np.zeros(m)
    trend = np.zeros(m)
    
    # SuperTrend Logic Loop (Vekt√∂rize edilmesi zor, d√∂ng√º kullanƒ±yoruz ama tarayƒ±cƒ± i√ßin hƒ±zlƒ±)
    for i in range(1, m):
        if basic_upper[i] < final_upper[i-1] or close[i-1] > final_upper[i-1]:
            final_upper[i] = basic_upper[i]
        else:
            final_upper[i] = final_upper[i-1]
            
        if basic_lower[i] > final_lower[i-1] or close[i-1] < final_lower[i-1]:
            final_lower[i] = basic_lower[i]
        else:
            final_lower[i] = final_lower[i-1]
            
        if trend[i-1] == 1:
            if close[i] < final_lower[i-1]:
                trend[i] = -1
            else:
                trend[i] = 1
        else: # trend was -1
            if close[i] > final_upper[i-1]:
                trend[i] = 1
            else:
                trend[i] = -1
                
    return trend, final_upper, final_lower, atr

def calculate_chandelier_numpy(high, low, close, length, mult):
    m = len(close)
    
    # ATR
    tr1 = high - low
    tr2 = np.abs(high - np.roll(close, 1))
    tr3 = np.abs(low - np.roll(close, 1))
    tr = np.maximum(tr1, np.maximum(tr2, tr3))
    
    atr = np.zeros(m)
    atr[length-1] = np.mean(tr[:length])
    alpha = 1.0 / length
    for i in range(length, m):
        atr[i] = (tr[i] * alpha) + (atr[i-1] * (1 - alpha))
        
    direction = np.zeros(m)
    long_stop = np.zeros(m)
    short_stop = np.zeros(m)
    
    for i in range(length, m):
        window_c = close[i-length+1:i+1]
        highest = np.max(window_c)
        lowest = np.min(window_c)
        
        ls_raw = highest - (atr[i] * mult)
        ss_raw = lowest + (atr[i] * mult)
        
        if close[i-1] > long_stop[i-1]:
            long_stop[i] = max(ls_raw, long_stop[i-1])
        else:
            long_stop[i] = ls_raw
            
        if close[i-1] < short_stop[i-1]:
            short_stop[i] = min(ss_raw, short_stop[i-1])
        else:
            short_stop[i] = ss_raw
            
        if close[i] > short_stop[i-1]:
            direction[i] = 1
        elif close[i] < long_stop[i-1]:
            direction[i] = -1
        else:
            direction[i] = direction[i-1]
            
    return direction

def calculate_rsi_numpy(close, period):
    delta = np.diff(close)
    gain = np.where(delta > 0, delta, 0)
    loss = np.where(delta < 0, -delta, 0)
    
    avg_gain = np.zeros_like(close)
    avg_loss = np.zeros_like(close)
    
    avg_gain[period] = np.mean(gain[:period])
    avg_loss[period] = np.mean(loss[:period])
    
    for i in range(period + 1, len(close)):
        avg_gain[i] = (avg_gain[i-1] * (period - 1) + gain[i-1]) / period
        avg_loss[i] = (avg_loss[i-1] * (period - 1) + loss[i-1]) / period
        
    rs = avg_gain / (avg_loss + 1e-10)
    rsi = 100 - (100 / (1 + rs))
    return rsi

def backtest_logic(close, st_trend, ce_dir, rsi_val):
    commission = 0.002
    initial_capital = 100000
    cash = initial_capital
    position = 0 # 0, 1, -1
    entry_price = 0
    equity = []
    
    trades = 0
    wins = 0
    
    for i in range(len(close)):
        # Signal
        signal = 0
        rsi_conf = 1 if rsi_val[i] > 50 else -1
        
        if st_trend[i] == 1 and ce_dir[i] == 1 and rsi_conf == 1:
            signal = 1
        elif st_trend[i] == -1 and ce_dir[i] == -1 and rsi_conf == -1:
            signal = -1
            
        # Execute
        current_price = close[i]
        
        if position != signal and signal != 0:
            # Close existing
            if position != 0:
                pnl = (current_price - entry_price) / entry_price if position == 1 else (entry_price - current_price) / entry_price
                pnl -= commission
                cash = cash * (1 + pnl)
                trades += 1
                if pnl > 0: wins += 1
            
            # Open new
            position = signal
            entry_price = current_price
            cash = cash * (1 - commission)
            
        # Calc Equity
        current_eq = cash
        if position != 0:
            unrealized = (current_price - entry_price) / entry_price if position == 1 else (entry_price - current_price) / entry_price
            current_eq = cash * (1 + unrealized)
            
        equity.append(current_eq)
        
    return np.array(equity), trades, wins

# ==============================================================================
# 2. VERƒ∞ √áEKME (CORS PROXY ƒ∞LE)
# ==============================================================================

async def fetch_data_proxy(symbol, interval):
    """
    Yahoo Finance verisini CORS proxy √ºzerinden √ßeker.
    GitHub.io statik bir site olduƒüu i√ßin bu y√∂ntem gereklidir.
    """
    # Yahoo Finance API v8 URL
    base_url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?interval={interval}&range=3mo"
    # CORS Proxy (Halka a√ßƒ±k bir proxy kullanƒ±yoruz, prod i√ßin kendi proxy'niz √∂nerilir)
    proxy_url = f"https://api.allorigins.win/get?url={base_url}"
    
    log(f"üåç Veri ƒ∞ndiriliyor: {symbol}...")
    
    try:
        response = await open_url(proxy_url)
        data = json.loads(response.read())
        
        # AllOrigins JSON yapƒ±sƒ±nƒ± √ß√∂z√ºmle
        contents = json.loads(data['contents'])
        
        if contents['chart']['error']:
            log("‚ùå HATA: Yahoo API hata d√∂nd√ºrd√º.")
            return None
            
        result = contents['chart']['result'][0]
        timestamps = result['timestamp']
        indicators = result['indicators']['quote'][0]
        
        df = pd.DataFrame({
            'Open': indicators['open'],
            'High': indicators['high'],
            'Low': indicators['low'],
            'Close': indicators['close']
        })
        
        # Temizlik
        df = df.dropna()
        log(f"‚úÖ Ba≈üarƒ±lƒ±: {len(df)} mum verisi alƒ±ndƒ±.")
        return df
        
    except Exception as e:
        log(f"‚ùå BAƒûLANTI HATASI: {str(e)}")
        log("‚ö†Ô∏è Not: CORS Proxy bazen yoƒüunluktan yanƒ±t vermeyebilir.")
        return None

# ==============================================================================
# 3. ANA ƒ∞≈ûLEM FONKSƒ∞YONU
# ==============================================================================

async def main_process(*args, **kwargs):
    # UI Elemanlarƒ±
    document.getElementById("loading_spinner").style.display = "block"
    document.getElementById("log_output").innerHTML = ""
    
    symbol = document.getElementById("symbol_input").value
    interval = document.getElementById("interval_input").value
    
    # 1. Veri √áek
    df = await fetch_data_proxy(symbol, interval)
    
    if df is None:
        document.getElementById("loading_spinner").style.display = "none"
        return

    # Veriyi Numpy array'e √ßevir
    h = df['High'].values
    l = df['Low'].values
    c = df['Close'].values
    
    # 2. Genetik Algoritma (Basitle≈ütirilmi≈ü - Web Hƒ±zƒ± ƒ∞√ßin)
    log("\nüß† AI Optimizasyonu Ba≈ülatƒ±lƒ±yor (Mini-Genetic)...")
    
    best_score = -99999
    best_params = {}
    
    # Tarayƒ±cƒ±yƒ± dondurmamak i√ßin daha az pop√ºlasyon
    population_size = 20 
    
    for _ in range(population_size):
        params = {
            'st_period': random.randint(7, 30),
            'st_mult': round(random.uniform(1.5, 4.0), 1),
            'ce_len': random.randint(10, 30),
            'rsi_len': random.randint(10, 20)
        }
        
        # Hesapla
        st_trend, _, _, _ = calculate_supertrend_numpy(h, l, c, params['st_period'], params['st_mult'])
        ce_dir = calculate_chandelier_numpy(h, l, c, params['ce_len'], 3.0)
        rsi_val = calculate_rsi_numpy(c, params['rsi_len'])
        
        equity, trades, wins = backtest_logic(c, st_trend, ce_dir, rsi_val)
        
        if trades < 3: score = -999
        else:
            ret = (equity[-1] - 100000) / 100000
            wr = wins / trades
            score = ret * wr
            
        if score > best_score:
            best_score = score
            best_params = params
            
    log(f"üíé En ƒ∞yi Parametreler Bulundu: {best_params}")
    
    # 3. Final Hesaplama & Grafik
    p = best_params
    st_trend, final_upper, final_lower, atr = calculate_supertrend_numpy(h, l, c, p['st_period'], p['st_mult'])
    ce_dir = calculate_chandelier_numpy(h, l, c, p['ce_len'], 3.0)
    rsi_val = calculate_rsi_numpy(c, p['rsi_len'])
    
    equity, trades, wins = backtest_logic(c, st_trend, ce_dir, rsi_val)
    
    # 4. Grafik √áizimi
    fig, ax = plt.subplots(figsize=(8, 4))
    ax.plot(equity, color='#3b82f6', linewidth=2)
    ax.set_title(f"Sermaye Eƒürisi ({symbol}) - Getiri: %{((equity[-1]-100000)/100000)*100:.2f}", color='white')
    ax.set_facecolor('#1e293b')
    fig.patch.set_facecolor('#1e293b')
    ax.tick_params(colors='white')
    ax.spines['bottom'].set_color('white')
    ax.spines['left'].set_color('white')
    
    # Grafiƒüi HTML'e bas
    document.getElementById("chart_area").innerHTML = ""
    display(fig, target="chart_area", append=False)
    
    # 5. Sinyal Kararƒ±
    last_st = st_trend[-1]
    last_ce = ce_dir[-1]
    last_rsi = rsi_val[-1]
    last_price = c[-1]
    last_atr = atr[-1]
    
    decision_text = "N√ñTR / BEKLE"
    decision_color = "text-warning"
    
    if last_st == 1 and last_ce == 1 and last_rsi > 50:
        decision_text = "G√ú√áL√ú AL (LONG) üöÄ"
        decision_color = "text-success"
        sl = last_price - (last_atr * 2)
        tp = last_price + (last_atr * 4)
    elif last_st == -1 and last_ce == -1 and last_rsi < 50:
        decision_text = "G√ú√áL√ú SAT (SHORT) üìâ"
        decision_color = "text-danger"
        sl = last_price + (last_atr * 2)
        tp = last_price - (last_atr * 4)
    else:
        sl = 0
        tp = 0
        
    # UI G√ºncelle
    dec_el = document.getElementById("final_decision")
    dec_el.innerHTML = decision_text
    dec_el.className = f"display-6 fw-bold {decision_color}"
    
    document.getElementById("stop_loss_disp").innerHTML = f"{sl:.2f}"
    document.getElementById("take_profit_disp").innerHTML = f"{tp:.2f}"
    
    log("\n‚úÖ ƒ∞≈ûLEM TAMAMLANDI.")
    document.getElementById("loading_spinner").style.display = "none"

</py-script>

</body>
</html>
