<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Algorithmic Trading - GitHub Edition</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --border: #334155;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 1000px;
            width: 100%;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 40px;
        }
        header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(to right, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        header p { color: var(--text-muted); }

        /* Controls */
        .controls {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 16px;
            border: 1px solid var(--border);
            display: flex;
            gap: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            margin-bottom: 30px;
        }

        input {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            flex-grow: 1;
            font-size: 1rem;
            outline: none;
        }

        button {
            background: var(--accent-blue);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        button:hover { background: #2563eb; transform: translateY(-2px); }
        button:disabled { background: var(--text-muted); cursor: not-allowed; }

        /* Grid Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .dashboard { grid-template-columns: 1fr; }
            .controls { flex-direction: column; }
        }

        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border);
            padding: 25px;
            height: fit-content;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Terminal/Log Output */
        #console-output {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            color: #10b981;
            height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        
        /* Result Highlights */
        .result-box {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .price-display {
            font-size: 2.5rem;
            font-weight: 800;
            margin: 10px 0;
        }
        .signal-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.9rem;
            text-transform: uppercase;
        }
        .signal-buy { background: rgba(16, 185, 129, 0.2); color: var(--accent-green); }
        .signal-sell { background: rgba(239, 68, 68, 0.2); color: var(--accent-red); }
        .signal-neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-muted); }

        .metric-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        /* Loading Spinner */
        #loader {
            display: none;
            margin-left: 10px;
        }
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

    </style>
    
    <py-config>
        packages = ["pandas", "numpy", "pyodide-http"]
    </py-config>
</head>
<body>

    <div class="container">
        <header>
            <h1><i class="fas fa-robot"></i> AI Trade Engine</h1>
            <p>Institutional Grade Analysis & Genetic Optimization</p>
        </header>

        <div class="controls">
            <input type="text" id="symbol_input" placeholder="Hisse Kodu (Ã–rn: THYAO.IS, AAPL, GARAN.IS)" value="THYAO.IS">
            <button id="run_btn">
                <i class="fas fa-play"></i> ANALÄ°ZÄ° BAÅžLAT
                <div id="loader" class="spinner"></div>
            </button>
        </div>

        <div class="dashboard">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-terminal"></i> SÄ°STEM LOGLARI
                </div>
                <div id="console-output">Sistem hazÄ±r. Python motoru yÃ¼kleniyor...</div>
            </div>

            <div class="card">
                <div class="card-title">
                    <i class="fas fa-chart-line"></i> AI KARARI
                </div>
                
                <div class="result-box">
                    <div id="final-signal" class="signal-badge signal-neutral">BEKLENÄ°YOR</div>
                    <div id="current-price" class="price-display">--.--</div>
                    <small id="last-update" style="color: var(--text-muted)">Veri yok</small>
                </div>

                <div id="details-panel">
                    <div class="metric-row">
                        <span>SuperTrend:</span>
                        <span id="st-val">--</span>
                    </div>
                    <div class="metric-row">
                        <span>Chandelier:</span>
                        <span id="ce-val">--</span>
                    </div>
                    <div class="metric-row">
                        <span>RSI (Wilder):</span>
                        <span id="rsi-val">--</span>
                    </div>
                    <hr style="border-color: var(--border); opacity: 0.3;">
                    <div class="metric-row">
                        <span>AI GÃ¼ven Skoru (Fit):</span>
                        <span id="fit-val" style="color: var(--accent-blue)">--</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <py-script>
import asyncio
import js
import pandas as pd
import numpy as np
import pyodide_http
import json
from pyodide.http import open_url
from js import console
# Yeni import: Python fonksiyonunu JS eventine baÄŸlamak iÃ§in gerekli
from pyodide.ffi import create_proxy

# Patch requests for browser
pyodide_http.patch_all()

# ==============================================================================
# BROWSER COMPATIBLE MATH ENGINE
# ==============================================================================

def log(message):
    """HTML konsoluna yazar"""
    console_elem = js.document.getElementById("console-output")
    console_elem.innerHTML += f"> {message}<br>"
    console_elem.scrollTop = console_elem.scrollHeight

def calculate_supertrend(high, low, close, period, multiplier):
    m = len(close)
    tr1 = pd.DataFrame(high - low)
    tr2 = pd.DataFrame(abs(high - pd.Series(close).shift(1)))
    tr3 = pd.DataFrame(abs(low - pd.Series(close).shift(1)))
    frames = [tr1, tr2, tr3]
    tr = pd.concat(frames, axis=1, join='inner').max(axis=1)
    atr = tr.ewm(alpha=1/period, adjust=False).mean()
    
    hl2 = (high + low) / 2
    basic_upper = hl2 + (multiplier * atr)
    basic_lower = hl2 - (multiplier * atr)
    
    final_upper = basic_upper.copy()
    final_lower = basic_lower.copy()
    trend = np.zeros(m)
    
    f_upper = final_upper.values
    f_lower = final_lower.values
    c = close.values
    b_upper = basic_upper.values
    b_lower = basic_lower.values
    
    trend[period-1] = 1
    
    for i in range(period, m):
        if b_upper[i] < f_upper[i-1] or c[i-1] > f_upper[i-1]:
            f_upper[i] = b_upper[i]
        else:
            f_upper[i] = f_upper[i-1]
            
        if b_lower[i] > f_lower[i-1] or c[i-1] < f_lower[i-1]:
            f_lower[i] = b_lower[i]
        else:
            f_lower[i] = f_lower[i-1]
            
        if trend[i-1] == 1:
            if c[i] < f_lower[i-1]:
                trend[i] = -1
            else:
                trend[i] = 1
        else:
            if c[i] > f_upper[i-1]:
                trend[i] = 1
            else:
                trend[i] = -1
                
    return trend, atr.values

def calculate_chandelier(high, low, close, length, mult):
    high_s = pd.Series(high)
    low_s = pd.Series(low)
    close_s = pd.Series(close)
    
    tr1 = high_s - low_s
    tr2 = abs(high_s - close_s.shift(1))
    tr3 = abs(low_s - close_s.shift(1))
    tr = pd.concat([tr1, tr2, tr3], axis=1).max(axis=1)
    atr = tr.ewm(alpha=1/length, adjust=False).mean()
    
    highest_high = high_s.rolling(window=length).max()
    lowest_low = low_s.rolling(window=length).min()
    
    long_stop = highest_high - (atr * mult)
    short_stop = lowest_low + (atr * mult)
    
    direction = np.where(close_s > short_stop.shift(1), 1, 
                np.where(close_s < long_stop.shift(1), -1, 0))
    return direction

def calculate_rsi(close, period):
    delta = pd.Series(close).diff()
    gain = (delta.where(delta > 0, 0)).fillna(0)
    loss = (-delta.where(delta < 0, 0)).fillna(0)
    
    avg_gain = gain.ewm(alpha=1/period, adjust=False).mean()
    avg_loss = loss.ewm(alpha=1/period, adjust=False).mean()
    
    rs = avg_gain / avg_loss
    rsi = 100 - (100 / (1 + rs))
    return rsi.values

# ==============================================================================
# DATA FETCHER (PROXY REQUIRED FOR BROWSER)
# ==============================================================================
async def fetch_stock_data(symbol):
    log(f"ðŸ“¡ Veri indiriliyor: {symbol}")
    
    import time
    import json
    
    # Zaman aralÄ±ÄŸÄ± (Son 30 gÃ¼n)
    period2 = int(time.time())
    period1 = period2 - (60 * 60 * 24 * 30) 
    
    # YÃ–NTEM 1: Corsproxy.io (Daha kararlÄ±)
    # Yahoo Finance API v8 endpoint
    target_url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?period1={period1}&period2={period2}&interval=60m&includePrePost=false&events=div%7Csplit"
    
    # Proxy servisi Ã¼zerinden istek
    # Not: encodeURIComponent benzeri bir iÅŸlem gerekebilir, ancak basit URL'lerde doÄŸrudan Ã§alÄ±ÅŸÄ±r.
    proxy_url = f"https://corsproxy.io/?{target_url}"
    
    log(f"â„¹ï¸ BaÄŸlanÄ±lÄ±yor: Yahoo Finance (via Secure Proxy)...")
    
    try:
        # Pyodide fetch kullanÄ±mÄ±
        response = await js.fetch(proxy_url)
        
        if not response.ok:
            log(f"âš ï¸ HTTP HatasÄ±: {response.status}")
            # Alternatif Proxy Denemesi (Yedek Plan)
            log("ðŸ”„ Yedek proxy deneniyor...")
            fallback_url = f"https://api.allorigins.win/raw?url={target_url}"
            response = await js.fetch(fallback_url)
        
        if not response.ok:
            raise Exception(f"Sunucu yanÄ±t vermedi: {response.status}")

        data_json = await response.json()
        
        # Yahoo Finance JSON yapÄ±sÄ±nÄ± ayrÄ±ÅŸtÄ±r
        # Bazen 'chart' anahtarÄ± en Ã¼stte olur
        if "chart" not in data_json:
             # allorigins bazen string dÃ¶ndÃ¼rÃ¼r, parse etmek gerekebilir
             if isinstance(data_json, str):
                 data_json = json.loads(data_json)
        
        if "chart" not in data_json or "result" not in data_json["chart"] or not data_json["chart"]["result"]:
            log("âŒ Veri boÅŸ veya sembol hatalÄ± (Ã–rn: THYAO.IS).")
            return None
            
        result = data_json["chart"]["result"][0]
        timestamps = result["timestamp"]
        indicators = result["indicators"]["quote"][0]
        
        # DataFrame oluÅŸtur
        df = pd.DataFrame({
            'Open': indicators['open'],
            'High': indicators['high'],
            'Low': indicators['low'],
            'Close': indicators['close']
        })
        
        # Datetime index (Saniye cinsinden)
        df.index = pd.to_datetime(timestamps, unit='s')
        
        # Eksik verileri temizle
        df = df.dropna()
        
        log(f"âœ… {len(df)} bar veri alÄ±ndÄ± ve iÅŸlendi.")
        return df
        
    except Exception as e:
        log(f"âŒ Kritik Hata: {str(e)}")
        log("ðŸ’¡ Ä°pucu: TarayÄ±cÄ± reklam engelleyicinizi kapatmayÄ± deneyin.")
        return None

# ==============================================================================
# OPTIMIZATION & SIGNAL ENGINE
# ==============================================================================
class WebStrategy:
    def __init__(self, df):
        self.df = df
        self.best_params = {}
        
    def evaluate(self, params):
        h = self.df['High']
        l = self.df['Low']
        c = self.df['Close']
        
        st_trend, _ = calculate_supertrend(h, l, c, int(params['st_period']), params['st_mult'])
        ce_dir = calculate_chandelier(h, l, c, int(params['ce_length']), 3.0)
        rsi = calculate_rsi(c, int(params['rsi_len']))
        
        st_trend = np.array(st_trend)
        ce_dir = np.array(ce_dir)
        rsi = np.array(rsi)
        close_arr = c.values
        
        signals = np.zeros(len(c))
        long_cond = (st_trend == 1) & (ce_dir == 1) & (rsi > 50)
        signals[long_cond] = 1
        
        pct_change = pd.Series(close_arr).pct_change().shift(-1).fillna(0).values
        strategy_returns = signals * pct_change
        
        total_return = np.sum(strategy_returns)
        win_rate = np.mean(strategy_returns > 0)
        fitness = (total_return * 100) + (win_rate * 50)
        return fitness, total_return

    def optimize(self):
        log("ðŸ§  Genetik Algoritma BaÅŸlatÄ±lÄ±yor (Web Mode)...")
        import random
        
        population_size = 15
        generations = 5
        
        population = []
        for _ in range(population_size):
            population.append({
                'st_period': random.randint(7, 30),
                'st_mult': round(random.uniform(1.5, 5.0), 1),
                'ce_length': random.randint(10, 30),
                'rsi_len': random.randint(7, 25)
            })
            
        best_dna = population[0]
        best_fit = -9999
        
        for gen in range(generations):
            scores = []
            for dna in population:
                fit, _ = self.evaluate(dna)
                scores.append((dna, fit))
            
            scores.sort(key=lambda x: x[1], reverse=True)
            best_dna, best_fit = scores[0]
            
            log(f"ðŸš€ Gen {gen+1}/{generations} | Skor: {best_fit:.2f}")
            
            next_gen = [x[0] for x in scores[:5]]
            while len(next_gen) < population_size:
                p1 = random.choice(scores[:5])[0]
                child = p1.copy()
                if random.random() < 0.3:
                    child['st_period'] = max(5, child['st_period'] + random.choice([-2, 2]))
                next_gen.append(child)
            population = next_gen
            
        self.best_params = best_dna
        log(f"ðŸ’Ž Optimum Parametreler: {best_dna}")
        return best_dna

    def get_final_signal(self):
        p = self.best_params
        h = self.df['High']
        l = self.df['Low']
        c = self.df['Close']
        
        st_trend, _ = calculate_supertrend(h, l, c, int(p['st_period']), p['st_mult'])
        ce_dir = calculate_chandelier(h, l, c, int(p['ce_length']), 3.0)
        rsi = calculate_rsi(c, int(p['rsi_len']))
        
        last_st = st_trend[-1]
        last_ce = ce_dir[-1]
        if isinstance(last_ce, (pd.Series, np.ndarray)):
            last_ce = last_ce[-1] if len(np.shape(last_ce)) > 0 else last_ce
            
        last_rsi = rsi[-1]
        current_price = c.iloc[-1]
        
        signal = "NÃ–TR"
        css_class = "signal-neutral"
        
        if last_st == 1 and last_ce == 1 and last_rsi > 50:
            signal = "GÃœÃ‡LÃœ AL (STRONG BUY)"
            css_class = "signal-buy"
        elif last_st == -1 and last_ce == -1 and last_rsi < 50:
            signal = "GÃœÃ‡LÃœ SAT (STRONG SELL)"
            css_class = "signal-sell"
            
        return {
            'signal': signal,
            'css_class': css_class,
            'price': current_price,
            'st': 'YUKARI' if last_st == 1 else 'AÅžAÄžI',
            'ce': 'YUKARI' if last_ce == 1 else 'AÅžAÄžI',
            'rsi': round(last_rsi, 2)
        }

# Bu fonksiyon artÄ±k 'event' parametresi alÄ±yor
async def start_analysis_event(event):
    symbol_input = js.document.getElementById("symbol_input").value
    btn = js.document.getElementById("run_btn")
    loader = js.document.getElementById("loader")
    
    js.document.getElementById("console-output").innerHTML = ""
    btn.disabled = True
    loader.style.display = "inline-block"
    
    symbol = symbol_input.strip().upper()
    if not symbol: symbol = "THYAO.IS"
        
    log(f"SÃ¼reÃ§ baÅŸlatÄ±lÄ±yor: {symbol}")
    
    df = await fetch_stock_data(symbol)
    
    if df is not None and not df.empty:
        strategy = WebStrategy(df)
        best_dna = strategy.optimize()
        result = strategy.get_final_signal()
        
        js.document.getElementById("final-signal").innerHTML = result['signal']
        js.document.getElementById("final-signal").className = f"signal-badge {result['css_class']}"
        js.document.getElementById("current-price").innerHTML = f"{result['price']:.2f}"
        js.document.getElementById("st-val").innerHTML = result['st']
        js.document.getElementById("ce-val").innerHTML = result['ce']
        js.document.getElementById("rsi-val").innerHTML = str(result['rsi'])
        js.document.getElementById("fit-val").innerHTML = "High Confidence"
        js.document.getElementById("last-update").innerHTML = "Az Ã¶nce gÃ¼ncellendi"
    else:
        log("Ä°ÅŸlem baÅŸarÄ±sÄ±z.")
        
    btn.disabled = False
    loader.style.display = "none"

# ==============================================================================
# EVENT LISTENER SETUP (GÃœVENLÄ° YÃ–NTEM)
# ==============================================================================
def setup_events():
    # Python fonksiyonunu JS'e tanÄ±t
    run_proxy = create_proxy(start_analysis_event)
    
    # HTML butonunu bul
    btn = js.document.getElementById("run_btn")
    
    # Click olayÄ±nÄ± baÄŸla
    btn.addEventListener("click", run_proxy)
    
    # KullanÄ±cÄ±ya hazÄ±r olduÄŸunu bildir
    log("âœ… Sistem tamamen yÃ¼klendi ve hazÄ±r.")

# Setup fonksiyonunu Ã§alÄ±ÅŸtÄ±r
setup_events()

    </py-script>
</body>
</html>

