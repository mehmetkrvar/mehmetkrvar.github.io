<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Institutional AI Trader - Fixed</title>
    
    <link rel="stylesheet" href="https://pyscript.net/releases/2023.05.1/pyscript.css" />
    <script defer src="https://pyscript.net/releases/2023.05.1/pyscript.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .btn-primary { background-color: #3b82f6; border: none; }
        .btn-primary:hover { background-color: #2563eb; }
        .btn-primary:disabled { background-color: #475569; cursor: not-allowed; }
        pre { background-color: #000; color: #0f0; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; font-size: 12px; font-family: 'Courier New', Courier, monospace; }
        .loading { display: none; color: #3b82f6; }
        .metric-box { background: #334155; padding: 10px; border-radius: 8px; text-align: center; }
        .metric-title { font-size: 0.8rem; color: #94a3b8; }
        .metric-value { font-size: 1.2rem; font-weight: bold; }
    </style>

    <py-config>
        packages = ["pandas", "numpy", "matplotlib"]
    </py-config>
</head>
<body>

<div class="container py-5">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1><i class="fas fa-robot text-primary"></i> Institutional AI Trader</h1>
            <p class="text-muted">WebAssembly TabanlÄ± Algoritmik Motor</p>
        </div>
    </div>

    <div class="row">
        <div class="col-md-4">
            <div class="card shadow-lg mb-3">
                <div class="card-header fw-bold"><i class="fas fa-cogs"></i> Kontrol Paneli</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Hisse (Yahoo Kodu)</label>
                        <input type="text" id="symbol_input" class="form-control" value="THYAO.IS">
                    </div>
                    
                    <button id="run_btn" class="btn btn-primary w-100" disabled>
                        <i class="fas fa-hourglass-half"></i> Python YÃ¼kleniyor...
                    </button>

                    <div id="loading_spinner" class="loading mt-3 text-center">
                        <i class="fas fa-spinner fa-spin fa-2x"></i><br>
                        <span id="loading_text">Analiz YapÄ±lÄ±yor...</span>
                    </div>
                </div>
            </div>

            <div class="card shadow-lg">
                <div class="card-header fw-bold">AI KararÄ±</div>
                <div class="card-body text-center">
                    <h2 id="final_decision" class="display-6">--</h2>
                    <div class="row mt-3">
                        <div class="col-6">
                            <div class="metric-box">
                                <div class="metric-title">Stop Loss</div>
                                <div id="stop_loss_disp" class="metric-value text-danger">--</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="metric-box">
                                <div class="metric-title">Take Profit</div>
                                <div id="take_profit_disp" class="metric-value text-success">--</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card shadow-lg mb-3">
                <div class="card-header fw-bold">CanlÄ± Loglar</div>
                <div class="card-body p-0">
                    <pre id="log_output">Sistem baÅŸlatÄ±lÄ±yor, lÃ¼tfen bekleyin...</pre>
                </div>
            </div>
            
            <div class="card shadow-lg">
                <div class="card-header fw-bold">Equity Curve (Sermaye EÄŸrisi)</div>
                <div class="card-body">
                    <div id="chart_area"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<py-script>
import pandas as pd
import numpy as np
import random
import json
import asyncio
from pyodide.http import open_url
from pyodide.ffi import create_proxy
import matplotlib.pyplot as plt
from js import document, console, window

# ==========================================================
# YARDIMCI FONKSÄ°YONLAR
# ==========================================================
def log(msg):
    log_el = document.getElementById("log_output")
    log_el.innerHTML += f"\n> {msg}"
    log_el.scrollTop = log_el.scrollHeight
    console.log(msg)

def generate_dummy_data():
    """Proxy Ã§alÄ±ÅŸmazsa sistemi test etmek iÃ§in rastgele veri Ã¼retir"""
    log("âš ï¸ Ä°NTERNET VERÄ°SÄ° ALINAMADI: Demo (Rastgele) veri Ã¼retiliyor...")
    dates = pd.date_range(start="2023-01-01", periods=200, freq="15min")
    close = [100]
    for _ in range(199):
        change = random.uniform(-0.01, 0.01)
        close.append(close[-1] * (1 + change))
    
    df = pd.DataFrame({
        'Open': close, # Basitlik iÃ§in
        'High': [c * 1.005 for c in close],
        'Low': [c * 0.995 for c in close],
        'Close': close
    }, index=dates)
    
    # Tipleri dÃ¼zelt
    for col in df.columns:
        df[col] = df[col].astype(float)
        
    return df

# ==========================================================
# Ä°NDÄ°KATÃ–R MANTIÄžI (NUMPY)
# ==========================================================
def calculate_indicators(df):
    h = df['High'].values
    l = df['Low'].values
    c = df['Close'].values
    
    # 1. ATR
    period_atr = 14
    tr1 = h - l
    tr2 = np.abs(h - np.roll(c, 1))
    tr3 = np.abs(l - np.roll(c, 1))
    tr = np.maximum(tr1, np.maximum(tr2, tr3))
    tr[0] = tr[1]
    
    atr = np.zeros_like(c)
    atr[period_atr-1] = np.mean(tr[:period_atr])
    for i in range(period_atr, len(c)):
        atr[i] = (atr[i-1] * (period_atr - 1) + tr[i]) / period_atr
        
    # 2. SuperTrend (BasitleÅŸtirilmiÅŸ)
    st_mult = 3.0
    hl2 = (h + l) / 2
    final_upper = hl2 + (st_mult * atr)
    final_lower = hl2 - (st_mult * atr)
    trend = np.zeros_like(c)
    
    # Basit bir dÃ¶ngÃ¼
    for i in range(1, len(c)):
        if c[i] > final_upper[i-1]: trend[i] = 1
        elif c[i] < final_lower[i-1]: trend[i] = -1
        else: trend[i] = trend[i-1]
        
        # BandÄ± sÄ±kÄ±ÅŸtÄ±r
        if trend[i] == 1 and final_lower[i] < final_lower[i-1]: final_lower[i] = final_lower[i-1]
        if trend[i] == -1 and final_upper[i] > final_upper[i-1]: final_upper[i] = final_upper[i-1]

    # 3. RSI
    delta = np.diff(c)
    gain = np.where(delta > 0, delta, 0)
    loss = np.where(delta < 0, -delta, 0)
    avg_gain = np.zeros_like(c)
    avg_loss = np.zeros_like(c)
    
    # Basit SMA RSI
    avg_gain[14] = np.mean(gain[:14])
    avg_loss[14] = np.mean(loss[:14])
    for i in range(15, len(c)):
        avg_gain[i] = (avg_gain[i-1]*13 + gain[i-1])/14
        avg_loss[i] = (avg_loss[i-1]*13 + loss[i-1])/14
        
    rs = avg_gain / (avg_loss + 1e-10)
    rsi = 100 - (100 / (1 + rs))
    
    return trend, atr, rsi

# ==========================================================
# ANA SÃœREÃ‡
# ==========================================================
async def main_logic(event):
    # UI Reset
    document.getElementById("loading_spinner").style.display = "block"
    document.getElementById("run_btn").disabled = True
    document.getElementById("log_output").innerHTML = "Ä°ÅŸlem BaÅŸladÄ±..."
    
    symbol = document.getElementById("symbol_input").value
    log(f"Analiz ediliyor: {symbol}")
    
    try:
        # 1. VERÄ° Ã‡EKME DENEMESÄ°
        df = None
        log("ðŸŒ Yahoo Finance baÄŸlantÄ±sÄ± kuruluyor...")
        
        try:
            # AllOrigins Proxy
            base_url = f"https://query1.finance.yahoo.com/v8/finance/chart/{symbol}?interval=60m&range=1mo"
            proxy_url = f"https://api.allorigins.win/get?url={base_url}"
            
            response = await open_url(proxy_url)
            data_json = json.loads(response.read())
            contents = json.loads(data_json['contents'])
            
            if contents.get('chart', {}).get('result'):
                res = contents['chart']['result'][0]
                quotes = res['indicators']['quote'][0]
                df = pd.DataFrame({
                    'High': quotes['high'],
                    'Low': quotes['low'],
                    'Close': quotes['close']
                }).dropna()
                log(f"âœ… Veri BaÅŸarÄ±yla Ã‡ekildi: {len(df)} bar.")
            else:
                log("âŒ Yahoo API boÅŸ dÃ¶ndÃ¼.")
        except Exception as e:
            log(f"âŒ BaÄŸlantÄ± HatasÄ±: {str(e)}")
            
        # Fallback (Yedek) MekanizmasÄ±
        if df is None or len(df) < 20:
            df = generate_dummy_data()
            
        # 2. HESAPLAMA
        log("ðŸ§  Matematik motoru Ã§alÄ±ÅŸÄ±yor...")
        trend, atr, rsi = calculate_indicators(df)
        
        # Backtest (SimÃ¼lasyon)
        capital = [100000]
        pos = 0
        price = df['Close'].values
        
        for i in range(1, len(price)):
            # Al/Sat Sinyali
            signal = 0
            if trend[i] == 1 and rsi[i] > 50: signal = 1
            elif trend[i] == -1 and rsi[i] < 50: signal = -1
            
            # PnL
            ret = 0
            if pos != 0:
                ret = (price[i] - price[i-1]) / price[i-1]
                if pos == -1: ret = -ret
            
            capital.append(capital[-1] * (1 + ret))
            
            if signal != 0: pos = signal
            
        # 3. GRAFÄ°K
        log("ðŸ“Š Grafik Ã§iziliyor...")
        fig, ax = plt.subplots(figsize=(8, 4))
        ax.plot(capital, color='#3b82f6', linewidth=2)
        ax.set_title("SimÃ¼le EdilmiÅŸ Sermaye (Equity)", color='white')
        
        # Stil
        ax.set_facecolor('#1e293b')
        fig.patch.set_facecolor('#1e293b')
        ax.tick_params(axis='x', colors='white')
        ax.tick_params(axis='y', colors='white')
        ax.spines['bottom'].set_color('white')
        ax.spines['left'].set_color('white')
        
        document.getElementById("chart_area").innerHTML = ""
        display(fig, target="chart_area", append=False)
        
        # 4. KARAR
        last_price = price[-1]
        last_trend = trend[-1]
        last_rsi = rsi[-1]
        last_atr = atr[-1]
        
        if last_trend == 1:
            decision = "AL (BUY)"
            color = "text-success"
            sl = last_price - 2*last_atr
            tp = last_price + 4*last_atr
        else:
            decision = "SAT (SELL)"
            color = "text-danger"
            sl = last_price + 2*last_atr
            tp = last_price - 4*last_atr
            
        document.getElementById("final_decision").innerHTML = decision
        document.getElementById("final_decision").className = f"display-6 fw-bold {color}"
        document.getElementById("stop_loss_disp").innerHTML = f"{sl:.2f}"
        document.getElementById("take_profit_disp").innerHTML = f"{tp:.2f}"
        
        log("âœ… Analiz tamamlandÄ±.")

    except Exception as e:
        log(f"ðŸ’€ KRÄ°TÄ°K HATA: {str(e)}")
        console.error(e)
    
    finally:
        document.getElementById("loading_spinner").style.display = "none"
        document.getElementById("run_btn").disabled = False

# ==========================================================
# BAÅžLATMA (INIT)
# ==========================================================
def enable_button():
    btn = document.getElementById("run_btn")
    btn.disabled = False
    btn.innerHTML = '<i class="fas fa-play"></i> Analizi BaÅŸlat'
    log("Sistem hazÄ±r. Butona basabilirsiniz.")

    # Event Listener Ekleme (En gÃ¼venli yÃ¶ntem)
    proxy_func = create_proxy(main_logic)
    btn.addEventListener("click", proxy_func)

# Sayfa yÃ¼klendiÄŸinde butonu aktif et
enable_button()

</py-script>

</body>
</html>
