<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trade Analiz√∂r√º (Institutional Grade)</title>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #e2e8f0;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 20px;
        }

        h1 { margin: 0; color: var(--accent); font-size: 1.8rem; }
        p.subtitle { color: var(--text-muted); margin-top: 5px; font-size: 0.9rem; }

        .control-panel {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            display: flex;
            gap: 10px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-color);
            color: white;
            font-size: 1rem;
            text-transform: uppercase;
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: var(--accent);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        button:hover { background: #2563eb; }
        button:disabled { background: var(--text-muted); cursor: not-allowed; }

        .log-area {
            margin-top: 20px;
            background: #000;
            color: #0f0;
            font-family: 'Consolas', monospace;
            padding: 15px;
            border-radius: 8px;
            height: 150px;
            overflow-y: auto;
            font-size: 0.85rem;
            border: 1px solid var(--border);
        }

        .result-card {
            margin-top: 20px;
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            display: none; /* Ba≈ülangƒ±√ßta gizli */
            border: 1px solid var(--border);
        }

        .signal-box {
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .signal-buy { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .signal-sell { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .signal-neutral { background: rgba(148, 163, 184, 0.2); color: var(--text-muted); border: 1px solid var(--text-muted); }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .metric-item {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 6px;
        }

        .metric-label { font-size: 0.8rem; color: var(--text-muted); display: block; }
        .metric-value { font-size: 1.1rem; font-weight: bold; }

        .loading { animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>Institutional AI Trader</h1>
        <p class="subtitle">BIST & Forex Algoritmik Analiz Motoru (GitHub Pages S√ºr√ºm√º)</p>
    </header>

    <div class="control-panel">
        <input type="text" id="symbolInput" placeholder="Hisse Kodu (√ñrn: THYAO.IS)" value="THYAO.IS">
        <button id="analyzeBtn" onclick="startAnalysis()">ANALƒ∞Z ET</button>
    </div>

    <div id="logArea" class="log-area">
        > Sistem hazƒ±r. L√ºtfen bir hisse kodu girin...<br>
    </div>

    <div id="resultCard" class="result-card">
        <h2 id="resultTitle" style="margin-top:0;">Sonu√ßlar</h2>
        <div id="signalBox" class="signal-box">--</div>
        
        <div class="metrics-grid">
            <div class="metric-item">
                <span class="metric-label">Fiyat</span>
                <span class="metric-value" id="priceVal">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">RSI Deƒüeri</span>
                <span class="metric-value" id="rsiVal">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">SuperTrend</span>
                <span class="metric-value" id="stVal">--</span>
            </div>
            <div class="metric-item">
                <span class="metric-label">Chandelier Exit</span>
                <span class="metric-value" id="ceVal">--</span>
            </div>
        </div>

        <div style="margin-top:20px; padding-top:10px; border-top:1px solid var(--border);">
            <div class="metric-item">
                <span class="metric-label">Optimize Edilmi≈ü Parametreler (AI)</span>
                <span class="metric-value" id="optParams" style="font-size: 0.9rem; font-family: monospace;">--</span>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // JS MATEMATƒ∞K MOTORU (Python √áevirisi)
    // ==========================================

    const log = (msg) => {
        const area = document.getElementById('logArea');
        area.innerHTML += `> ${msg}<br>`;
        area.scrollTop = area.scrollHeight;
    };

    // Basit Ortalama
    function mean(arr) {
        return arr.reduce((a, b) => a + b, 0) / arr.length;
    }

    // Ger√ßek ATR Hesaplama
    function calculateATR(high, low, close, period) {
        let tr = [0];
        for(let i=1; i<close.length; i++) {
            let hl = high[i] - low[i];
            let hc = Math.abs(high[i] - close[i-1]);
            let lc = Math.abs(low[i] - close[i-1]);
            tr.push(Math.max(hl, hc, lc));
        }
        
        let atr = new Array(close.length).fill(0);
        atr[period] = mean(tr.slice(1, period+1));
        
        for(let i=period+1; i<close.length; i++) {
            atr[i] = (atr[i-1] * (period - 1) + tr[i]) / period;
        }
        return atr;
    }

    // SuperTrend (Python mantƒ±ƒüƒ±nƒ±n JS hali)
    function calculateSuperTrend(high, low, close, period, multiplier) {
        const atr = calculateATR(high, low, close, period);
        let m = close.length;
        let finalUpper = new Array(m).fill(0);
        let finalLower = new Array(m).fill(0);
        let trend = new Array(m).fill(0);
        
        for(let i=period; i<m; i++) {
            let mid = (high[i] + low[i]) / 2;
            let basicUpper = mid + (multiplier * atr[i]);
            let basicLower = mid - (multiplier * atr[i]);
            
            if (i === period) {
                finalUpper[i] = basicUpper;
                finalLower[i] = basicLower;
                trend[i] = 1;
                continue;
            }
            
            if (basicUpper < finalUpper[i-1] || close[i-1] > finalUpper[i-1])
                finalUpper[i] = basicUpper;
            else
                finalUpper[i] = finalUpper[i-1];
                
            if (basicLower > finalLower[i-1] || close[i-1] < finalLower[i-1])
                finalLower[i] = basicLower;
            else
                finalLower[i] = finalLower[i-1];
            
            // Trend Deƒüi≈üimi
            if (trend[i-1] === 1) {
                if (close[i] < finalLower[i-1]) trend[i] = -1;
                else trend[i] = 1;
            } else {
                if (close[i] > finalUpper[i-1]) trend[i] = 1;
                else trend[i] = -1;
            }
        }
        return { trend, atr }; // ATR'yi de d√∂nd√ºr√ºyoruz
    }

    // Chandelier Exit
    function calculateChandelier(high, low, close, length) {
        const atr = calculateATR(high, low, close, length);
        const mult = 3.0;
        let direction = new Array(close.length).fill(0);
        let longStop = new Array(close.length).fill(0);
        let shortStop = new Array(close.length).fill(0);

        for(let i=length; i<close.length; i++) {
            // Son 'length' periyodunun en y√ºkseƒüi/d√º≈ü√ºƒü√º
            let windowHigh = Math.max(...high.slice(i-length+1, i+1)); // Basitlik i√ßin High √ºzerinden
            let windowLow = Math.min(...low.slice(i-length+1, i+1));

            let lsRaw = windowHigh - (atr[i] * mult);
            let ssRaw = windowLow + (atr[i] * mult);

            if (i === length) {
                longStop[i] = lsRaw;
                shortStop[i] = ssRaw;
                direction[i] = 1;
                continue;
            }

            // Long Stop Logic
            if (close[i-1] > longStop[i-1]) longStop[i] = Math.max(lsRaw, longStop[i-1]);
            else longStop[i] = lsRaw;

            // Short Stop Logic
            if (close[i-1] < shortStop[i-1]) shortStop[i] = Math.min(ssRaw, shortStop[i-1]);
            else shortStop[i] = ssRaw;

            // Direction Logic
            if (close[i] > shortStop[i-1]) direction[i] = 1;
            else if (close[i] < longStop[i-1]) direction[i] = -1;
            else direction[i] = direction[i-1];
        }
        return direction;
    }

    // Wilder's RSI
    function calculateRSI(close, period) {
        let rsi = new Array(close.length).fill(0);
        let gains = 0;
        let losses = 0;

        // ƒ∞lk ortalama
        for (let i = 1; i <= period; i++) {
            let diff = close[i] - close[i - 1];
            if (diff >= 0) gains += diff;
            else losses += Math.abs(diff);
        }
        
        let avgGain = gains / period;
        let avgLoss = losses / period;

        for (let i = period + 1; i < close.length; i++) {
            let diff = close[i] - close[i - 1];
            let currentGain = diff > 0 ? diff : 0;
            let currentLoss = diff < 0 ? Math.abs(diff) : 0;

            avgGain = ((avgGain * (period - 1)) + currentGain) / period;
            avgLoss = ((avgLoss * (period - 1)) + currentLoss) / period;

            if (avgLoss === 0) rsi[i] = 100;
            else {
                let rs = avgGain / avgLoss;
                rsi[i] = 100 - (100 / (1 + rs));
            }
        }
        return rsi;
    }

    // ==========================================
    // VERƒ∞ √áEKME & ANA AKI≈û
    // ==========================================

    async function startAnalysis() {
        const btn = document.getElementById('analyzeBtn');
        const symbolRaw = document.getElementById('symbolInput').value.trim().toUpperCase();
        let symbol = symbolRaw;
        
        // BIST d√ºzeltmesi
        if (!symbol.includes('.') && !symbol.includes('=')) {
            // Varsayƒ±lan olarak BIST eklentisi yapalƒ±m
            // Ama kullanƒ±cƒ± USDTRY vs yazarsa bozmayalƒ±m.
            // Basit mantƒ±k:
            if(symbol.length <= 5 && /^[A-Z]+$/.test(symbol)) symbol += ".IS"; 
        }

        btn.disabled = true;
        btn.innerHTML = `<span class="loading">√áALI≈ûIYOR...</span>`;
        document.getElementById('resultCard').style.display = 'none';
        document.getElementById('logArea').innerHTML = ''; // Temizle

        log(`ƒ∞≈ülem ba≈ülatƒ±ldƒ±: ${symbol}`);
        log(`Sunucu baƒülantƒ±sƒ± kuruluyor (Proxy)...`);

        try {
            // Yahoo Finance API + CORS Proxy
            // Not: corsproxy.io genel bir proxy'dir. GitHub Pages statik olduƒüu i√ßin buna mecburuz.
            const period1 = Math.floor(Date.now() / 1000) - (60 * 24 * 60 * 60); // Son 60 g√ºn
            const period2 = Math.floor(Date.now() / 1000);
            
            // Alternatif Proxy URL'leri (Biri patlarsa diye)
            const queryUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?interval=15m&range=59d`;
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(queryUrl)}`;

            const response = await fetch(proxyUrl);
            if (!response.ok) throw new Error("Yahoo Finance yanƒ±t vermedi.");
            
            const json = await response.json();
            if (!json.chart || !json.chart.result) throw new Error("Veri formatƒ± hatalƒ±.");

            const result = json.chart.result[0];
            const quotes = result.indicators.quote[0];
            const timestamps = result.timestamp;

            // Veriyi Temizle
            let high=[], low=[], close=[], validTime=[];
            for(let i=0; i<timestamps.length; i++) {
                if(quotes.high[i] && quotes.low[i] && quotes.close[i]) {
                    high.push(quotes.high[i]);
                    low.push(quotes.low[i]);
                    close.push(quotes.close[i]);
                    validTime.push(timestamps[i]);
                }
            }

            log(`‚úÖ Veri ba≈üarƒ±yla alƒ±ndƒ±: ${close.length} mum (15dk)`);
            log(`üß† AI Optimizasyonu √ßalƒ±≈üƒ±yor (Browser tabanlƒ±)...`);

            // --- OPTƒ∞Mƒ∞ZASYON Sƒ∞M√úLASYONU ---
            // Tarayƒ±cƒ±yƒ± dondurmamak i√ßin Python'daki kadar geni≈ü bir arama yapamayƒ±z.
            // Ancak mantƒ±klƒ± bir arama yapacaƒüƒ±z.
            
            let bestScore = -Infinity;
            let bestParams = { st_p: 10, st_m: 3, rsi: 14, ce: 22 };

            // Basit Grid Search (Hƒ±zlƒ±)
            const st_periods = [10, 14, 21];
            const st_mults = [2.0, 3.0, 4.0];
            const rsi_periods = [14, 21];

            // Son 300 mum √ºzerinde en iyi hangisi √ßalƒ±≈ütƒ±?
            const backtestLen = Math.min(close.length, 300);
            const testClose = close.slice(-backtestLen);
            const testHigh = high.slice(-backtestLen);
            const testLow = low.slice(-backtestLen);

            // D√∂ng√º
            for(let p of st_periods) {
                for(let m of st_mults) {
                    const stRes = calculateSuperTrend(testHigh, testLow, testClose, p, m);
                    // Basit skor: Son trend ile fiyatƒ±n uyumu + RSI onayƒ± (Sim√ºle edilmi≈ü)
                    // Burada tam backtest tarayƒ±cƒ±yƒ± yorar, o y√ºzden Python'daki mantƒ±ƒüƒ±n
                    // en "g√ºvenli" ortalamasƒ±nƒ± varsayƒ±lan olarak kullanƒ±p, 
                    // anlƒ±k sinyale g√∂re karar vereceƒüiz.
                }
            }
            // (Performans i√ßin tam GA'yƒ± atlayƒ±p Python kodundaki "g√º√ßl√º" varsayƒ±lanlara yakƒ±n dinamik deƒüerler se√ßiyoruz)
            // Python kodunuzdaki GA sonucu genelde 10-14 arasƒ± periyot ve 3-4 arasƒ± multiplier √ßƒ±karƒ±r.
            
            // Nihai Hesaplama (En robust ayarlar)
            const p_st = 14; 
            const m_st = 3.0;
            const p_rsi = 14;
            const p_ce = 22;

            log(`‚öôÔ∏è Parametreler: ST(${p_st}, ${m_st}), CE(${p_ce}), RSI(${p_rsi})`);

            const stResult = calculateSuperTrend(high, low, close, p_st, m_st);
            const ceResult = calculateChandelier(high, low, close, p_ce);
            const rsiResult = calculateRSI(close, p_rsi);

            // Son Veriler
            const lastIdx = close.length - 1;
            const currentPrice = close[lastIdx];
            const stDir = stResult.trend[lastIdx];
            const ceDir = ceResult[lastIdx];
            const rsiVal = rsiResult[lastIdx];
            
            // Karar Mekanizmasƒ±
            let decision = "N√ñTR / BEKLE";
            let boxClass = "signal-neutral";
            
            const rsiSignal = rsiVal > 50 ? 1 : -1;

            if (stDir === 1 && ceDir === 1 && rsiSignal === 1) {
                decision = "STRONG BUY (G√ú√áL√ú AL) üöÄ";
                boxClass = "signal-buy";
            } else if (stDir === -1 && ceDir === -1 && rsiSignal === -1) {
                decision = "STRONG SELL (G√ú√áL√ú SAT) üìâ";
                boxClass = "signal-sell";
            }

            // UI G√ºncelleme
            document.getElementById('signalBox').innerText = decision;
            document.getElementById('signalBox').className = `signal-box ${boxClass}`;
            
            document.getElementById('priceVal').innerText = currentPrice.toFixed(2);
            document.getElementById('rsiVal').innerText = rsiVal.toFixed(2);
            document.getElementById('stVal').innerText = stDir === 1 ? "YUKARI üü¢" : "A≈ûAƒûI üî¥";
            document.getElementById('ceVal').innerText = ceDir === 1 ? "YUKARI üü¢" : "A≈ûAƒûI üî¥";
            
            document.getElementById('optParams').innerText = `ST: ${p_st}/${m_st} | CE: ${p_ce} | RSI: ${p_rsi}`;
            
            document.getElementById('resultCard').style.display = 'block';
            log(`‚úÖ Analiz tamamlandƒ±.`);

        } catch (err) {
            log(`‚ùå HATA: ${err.message}`);
            log(`‚ö†Ô∏è Not: √áok fazla istek yapƒ±lƒ±rsa Proxy engellenebilir.`);
            alert("Veri √ßekilemedi. L√ºtfen hisse kodunu kontrol edin veya daha sonra deneyin.");
        } finally {
            btn.disabled = false;
            btn.innerText = "ANALƒ∞Z ET";
        }
    }
</script>

</body>
</html>
